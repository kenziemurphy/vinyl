<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>MusicOctoRobot</title>
		<link rel="stylesheet" href="https://use.typekit.net/zry1rcu.css">
		<link rel="stylesheet" href="https://nico-amsterdam.github.io/awesomplete-util/css/awesomplete.css">
        <link rel="stylesheet" href="css/histograms.css" />
        <link rel="stylesheet" href="css/radialplot.css" />
        <link rel="stylesheet" href="css/starplot.css" />
        <link rel="stylesheet" href="css/main.css" />
    </head>
    <body>
		<!-- TODO remove inline CSS -->
        <div class="container">
			<div style="flex-grow: 1; width: 25%;" class="full-height">
				<h1>MusicOctoRobot</h1>
				<input class="form-control" id="search-artist" name="search[artist]" type="text" placeholder="Search artists..." />
				<br>
				<svg id="..."></svg>
				<div>
					<button id="toggle-split-view" class="btn">Toggle split view</button>
					<br><br><button id="toggle-album-art" class="btn">Toggle album art</button>
					<br><br><button id="toggle-force" class="btn">Toggle force jittering</button>
				</div>
            </div>
			<div style="flex-grow: 2; min-width: 50%; display: flex; flex-direction: column;" class="full-height">
				<div id="vis-area" class="vis-stretch" style="display: flex; flex-direction: column;">
					<div id="radial-view-controls" class="controls" style="flex-grow: 0; height: 0;">
						<button class="btn radial-mapping-select active" data-scale-type="linear" data-attr="tempo">TEMPO</button>
						<button class="btn radial-mapping-select" data-scale-type="linear"    data-attr="loudness">LOUDNESS</button>
						<button class="btn radial-mapping-select" data-scale-type="linear" data-scale-min="0" data-scale-max="1" data-attr="danceability">DANCEABILITY</button>
						<button class="btn radial-mapping-select" data-scale-type="linear" data-scale-min="0" data-scale-max="1" data-attr="acousticness">ACOUSTICNESS</button>
						<button class="btn radial-mapping-select" data-scale-type="linear" data-scale-min="0" data-scale-max="1" data-attr="instrumentalness">INSTRUMENTALNESS</button>
						<button class="btn radial-mapping-select" data-scale-type="linear" data-scale-min="0" data-scale-max="1" data-attr="liveness">LIVENESS</button>
						<button class="btn radial-mapping-select" data-scale-type="linear" data-scale-min="0" data-scale-max="1" data-attr="speechiness">SPEECHINESS</button>
						<button class="btn radial-mapping-select" data-scale-type="linear" data-scale-min="0" data-scale-max="1" data-attr="energy">ENERGY</button>
						<button class="btn radial-mapping-select" data-scale-type="linear" data-scale-min="0" data-scale-max="1" data-attr="valence">VALENCE</button>
						<button class="btn radial-mapping-select" data-scale-type="linear" data-scale-min="0" data-scale-max="100" data-attr="popularity">POPULARITY</button>
						<button class="btn radial-mapping-select" data-scale-type="linear" data-attr="release_year">YEAR</button>
						<button class="btn radial-mapping-select" data-scale-type="linear" data-attr="duration">DURATION</button>
	
						<!-- <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="track_number">Track Number</button> -->
						<!-- <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="key">Key</button> -->
						<!-- <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="mode">Mode</button> -->
						<!-- <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="time_signature">Time Signature</button> -->
					</div>
					<svg id="radial-view" class="vis-stretch" overflow="visible"></svg>
				</div>
					<h2 style="text-align:center; margin-top:50px;">Detailed Analysis</h2>
				<div id="drop-area" style="height: 7vh; display: flex; flex-direction: column; justify-content:center; align-items:center;">
					Drag a song here for more details
				</div>
            </div>
			<div style="flex-grow: 1; width: 25%; display: flex; flex-direction: column;" class="full-height">
				<!-- <h2>Distribution</h2> -->
        <br/>
				<svg id="histogram-view" class="vis-stretch"></svg>
            </div>
		</div>
		<div class="container">
			<div style="flex-grow: 1;">
				<!--<h2>Detailed Analysis</h2>-->
				<svg id="star-view" class="vis-stretch" overflow="visible"></svg>
			</div>
		</div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.12.0/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js"></script>
        <script src="https://nico-amsterdam.github.io/awesomplete-util/js/awesomplete.min.js"></script>
  		<script src="https://nico-amsterdam.github.io/awesomplete-util/js/awesomplete-util.min.js"></script>
        <script src="js/utils.js"></script>
        <script src="js/audiohelpers.js"></script>
        <script src="js/radialgrid.js"></script>
        <!-- <script src="js/radialplot.js"></script> -->
        <script src="js/radialplot_with_split.js"></script>
        <script src="js/histograms.js"></script>
        <script src="js/starplots.js"></script>

        <script>
			var components = [];
			var data = [];

			var newData = [];

			var dispatch = d3.dispatch('filter', 'highlight');

			var rv
			components.push(rv = new RadialView(d3.select('svg#radial-view'), [], dispatch));
			components.push(new HistogramView(d3.select('svg#histogram-view'), [], dispatch));
			//components.push(new StarView(d3.select('svg#star-view'), [], dispatch));

            // Load data and call onDataChanged for components once load is complete
            // TODO: remove this and just call appendArtistData instead each time the user adds an artist using the search bar
            loadData("data/merged.json", "data/merged_trackinfo.json");
            

			dispatch.on("filter", function (filterFunc) {
				components.forEach(function (c) { c.onFilter(filterFunc); });
			});

			dispatch.on("highlight", function (filterFunc) {
				components.forEach(function (c) { c.onHighlight(filterFunc); });
			});

            window.addEventListener("resize", function() {
				components.forEach(function (c) { c.onScreenSizeChanged(); });
			});

			// UI events
			document.getElementById('toggle-split-view')
				.addEventListener('click', function (e) {
					rv.setConfig({isSplitting: !rv.config.isSplitting});
				}, false);

			document.getElementById('toggle-album-art')
				.addEventListener('click', function (e) {
					rv.setConfig({showAlbumArt: !rv.config.showAlbumArt});
				}, false);

			document.getElementById('toggle-force')
				.addEventListener('click', function (e) {
					rv.setConfig({enableForce: !rv.config.enableForce});
				}, false);

			// Searchbar
			AwesompleteUtil.start('#search-artist',
				 {  /* util options */
				   url:    "https://oeeppedclg.execute-api.us-east-1.amazonaws.com/musicoctorobot/search?searchString=",
				   urlEnd: "*",
				   limit: 1
				 }, 
				 {  /* awesomplete options */
				   minChars: 1,
				   data: (rec, input) => {

				   	return { 
			         label: rec['name'], 
			         value: rec['id']
			       };

				  }
				 }
			);

			// Listen to searchbar selection
			document.getElementById('search-artist').addEventListener("awesomplete-selectcomplete", function(event) {

			    // Clear the searchbar to be ready for a new search
			    document.getElementById('search-artist').value = "";

			    // Retrieve songs for this artist from our API
			    var artistID = event.text.value;
			    appendArtistData(artistID);
			});

			// helpers
			function preprocessData (files) {
				// inner join
				var data = arrayJoin(files[0], files[1].tracks, 'id');
				data.forEach(function (d) {
					d.duration = d.duration_ms / 1000;
					d.release_year = d.album.release_date.indexOf('-') < 0 ?
						+d.album.release_date :
						+d.album.release_date.substring(0, d.album.release_date.indexOf('-'));
				})
				return data;
			}

			function arrayJoin (a, b, key) {
				var bKeys = b.map(y => y[key]);
				var abJoined = a.map(function (x) {
					var bIndex = bKeys.indexOf(x[key])
					if (bIndex >= 0) {
						return {...x, ...b[bIndex]};
					} else {
						return false;
					}
				});

				return abJoined.filter(x => x !== false);
			}

			function loadData(src1, src2) {
				Promise.all([
	                // d3.json('../../data/Spotify.json'),
	                // d3.json('../../data/Spotify_trackinfo.json'),
	                // d3.json('data/slotmachine.json'),
	                // d3.json('data/slotmachine_trackinfo.json'),
	                //d3.json("data/radiohead.json"),
					//d3.json("data/radiohead_trackinfo.json"),
					d3.json(src1),
					d3.json(src2)
					// d3.json("data/spoegwolf.json"),
					// d3.json("data/spoegwolf_trackinfo.json")
	            ]).then(function(loadedData) {
	            	// TODO: change data loading to use searchbar
					data = preprocessData(loadedData);
					console.log(data);

					components.forEach(function (c) { c.onDataChanged(data); });
				});
			}

			// Loads an array of song data for the given artistID and append that to our dataset
			function appendArtistData(artistID) {
				var url = "https://oeeppedclg.execute-api.us-east-1.amazonaws.com/musicoctorobot?artistId=" + artistID;

				d3.json(url).then((data) => {
					
					// Append to data array
					newData.push(data);

					console.log(newData);
				}).catch((error) => console.log(error));
			}

			// Removes the data for the artist at index i from the dataset
			function removeArtistData(i) {
				newData.splice(i, 1);
			}

			// Clears all selected artist data
			function clearArtistData() {
				newData = [];
			}



        </script>
    </body>
</html>
