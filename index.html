<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>MusicOctoRobot</title>
		<link rel="stylesheet" href="https://use.typekit.net/zry1rcu.css">
		<link rel="stylesheet" href="https://nico-amsterdam.github.io/awesomplete-util/css/awesomplete.css">
        <link rel="stylesheet" href="css/grids.css" />
        <link rel="stylesheet" href="css/histograms.css" />
        <link rel="stylesheet" href="css/radialplot.css" />
        <link rel="stylesheet" href="css/starplot.css" />
		<link rel="stylesheet" href="css/main.css" />

		<script src="https://kit.fontawesome.com/45bc1cc8f8.js" crossorigin="anonymous"></script>
    </head>
    <body>
		<!-- TODO remove inline CSS -->
        <div class="container-main container-row">
			<div style="width: 25%; padding-right: 5%;" class="cell container-col">
				<h1>MusicOctoRobot</h1>
				<div class="grow">
					<h2>I'm interested in...</h2>
					<input class="form-control" id="search-artist" name="search[artist]" type="text" placeholder="Search for an artist..." />
					<div id="artist-buttons">
						<!--<div class="artist-btn">Muse<button>&times;</button></div>
						<div class="artist-btn">Radiohead<button>&times;</button></div>
						<div class="artist-btn">Slot Machine<button>&times;</button></div>-->
					</div>
					<div class="text-center text-muted" style="line-height: 1;">
						<i><small>Up to 4 artists can be added<br>to the comparison</small></i>
					</div>
				</div>
				<div>
					<h2 id="select-more-options">More Options</h2>
					<div class="container-column" style="margin:auto;">
						<div class="cell panel" id="options-panel">
							<!-- <div class="cell grow mb-xs" style="margin-bottom: 10px;">
								<div>
									<small class="nowrap">Position data points by</small>
								</div>
								<div class="container-row">
									<div class="radio grow">
										<input type="radio" id="radio-pca-on" name="radio-pca" value="mode-pca">
										<label for="radio-pca-on" class="btn btn-block text-center add-help nowrap" data-help-key="mode-pca">Similarity </label>
									</div>
									<div class="grow radio">
										<input type="radio" id="radio-pca-off" name="radio-pca" value="mode-value" checked>
										<label for="radio-pca-off" class="btn btn-block text-center add-help nowrap" data-help-key="mode-value">Value </label>
									</div>
								</div>
							</div>
							<div class="cell mb-xs">
								<div class="margin-gutter">
									<small>X / Angular Axis</small>
									<br>
									<select name="" class="btn active vis-control" id="select-x-axis" style="width: 100%;">
										<option data-scale-type="linear" value="key_signature" data-radial="true">KEY</option>
										<option data-scale-type="linear" value="tempo">TEMPO</option>
										<option data-scale-type="linear" value="loudness">LOUDNESS</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="danceability">DANCEABILITY</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="acousticness">ACOUSTICNESS</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="instrumentalness">INSTRUMENTALNESS</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="liveness">LIVENESS</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="speechiness">SPEECHINESS</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="energy">ENERGY</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="valence">VALENCE</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="100" value="popularity">POPULARITY</option>
										<option data-scale-type="linear" value="release_year">YEAR</option>
										<option data-scale-type="linear" value="duration">DURATION</option>
										<option data-scale-type="linear" value="pca1">PCA1</option>
									</select>
								</div>
							</div>
							<div class="cell mb-xs">
								<div class="margin-gutter">
									<small>Y / Radial Axis</small>
									<br>
									<select name="" class="btn active vis-control" id="select-y-axis" style="width: 100%;">
										<option data-scale-type="linear" value="tempo">TEMPO</option>
										<option data-scale-type="linear" value="loudness">LOUDNESS</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="danceability">DANCEABILITY</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="acousticness">ACOUSTICNESS</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="instrumentalness">INSTRUMENTALNESS</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="liveness">LIVENESS</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="speechiness">SPEECHINESS</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="energy">ENERGY</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="valence">VALENCE</option>
										<option data-scale-type="linear" data-scale-min="0" data-scale-max="100" value="popularity">POPULARITY</option>
										<option data-scale-type="linear" value="release_year">YEAR</option>
										<option data-scale-type="linear" value="duration">DURATION</option>
										<option data-scale-type="linear" value="pca2">PCA2</option>
									</select>
								</div>
							</div> -->
							<div class="mb-xs">
								<div class="margin-gutter">
									<div class="mb-xxs">
										<small>Find a song on this chart</small>
									</div>
									<input type="text" class="btn vis-control" id="search-highlight" style="width: 100%;">
								</div>
							</div>

						<!-- </div> -->
						<!-- <div class="container-row">
							<div class="grow margin-gutter" style="width: 33.33%">
								<button id="toggle-split-view" class="btn vis-control">Toggle&shy; split view</button>
							</div>
							<div class="grow margin-gutter" style="width: 33.33%">
								<button id="toggle-album-art" class="btn vis-control">Toggle&shy;  album art</button>
							</div>
							<div class="grow margin-gutter" style="width: 33.33%">
								<button id="toggle-force" class="btn vis-control">Toggle&shy;  force jittering</button>
							</div>
						</div> -->
						<!-- <div class="container-col"> -->
							<div class="grow container-row mb-xs">
								<div class="grow">
									<small class="add-help" data-help-key="mode-pca">Just cluster similar songs </small>
								</div>
								<label class="switch vis-control">
									<input type="checkbox" id="toggle-pca" class="vis-control">
									<span class="slider round"></span>
								</label>
							</div>

							<div class="container-row mb-xs">
								<div class="grow">
									<small class="add-help" data-help-key="split-view">Split View </small>
								</div>
								<label class="switch vis-control">
									<input type="checkbox" id="toggle-split-view" class="vis-control">
									<span class="slider round"></span>
								</label>
							</div>
							<div class="container-row mb-xs">
								<div class="grow">
									<small>Show Album Cover</small>
								</div>
								<label class="switch vis-control">
									<input type="checkbox" id="toggle-album-art" class="vis-control">
									<span class="slider round"></span>
								</label>
							</div>
							<div class="container-row mb-xs">
								<div class="grow">
									<small>Avoid Overlapping</small>
								</div>
								<label class="switch vis-control">
									<input type="checkbox" id="toggle-force" class="vis-control">
									<span class="slider round"></span>
								</label>
							</div>
							<div class="container-row mb-xs">
								<button class="btn btn-block clickable" onclick="alert('TODO: show tutorial page again')">How to read this vis?</button>
							</div>
						</div>
					</div>
					<!-- <h2>About the Data</h2> -->
					<p class="text-muted" style="margin-bottom: 0;">
						<small>
							<b>About the Data</b>
							<i>The data visualized here were pulled from <a href="https://developer.spotify.com/" target="_blank">Spotify API</a>. Most data attributes are computed by Spotify's audio analysis algorithms.</i>
						</small>
					</p>
				</div>
            </div>
			<div class="cell grow container-col" style="margin-bottom: -30px;">
				<div id="vis-area" class="cell grow container-col">
					<div class="container-row">
						<!-- <div class="cell grow mb-xs" style="margin-bottom: 10px;">
							<div>
								<small class="nowrap">Position data points by</small>
							</div>
							<div class="container-row">
								<div class="radio grow">
									<input type="radio" id="radio-pca-on" name="radio-pca" value="mode-pca">
									<label for="radio-pca-on" class="btn btn-block text-center add-help nowrap clickable" data-help-key="mode-pca"><small>Group by Similarity</small> </label>
								</div>
								<div class="grow radio">
									<input type="radio" id="radio-pca-off" name="radio-pca" value="mode-value" checked>
									<label for="radio-pca-off" class="btn btn-block text-center add-help nowrap clickable" data-help-key="mode-value"><small>Plot by Value</small> </label>
								</div>
							</div>
						</div> -->
						<div class="cell grow">
							<div class="margin-gutter">
								<div>
									<small class="nowrap">X / Angular Axis</small>
								</div>
								<select name="" class="btn active vis-control" id="select-x-axis" style="width: 100%;">
									<option data-scale-type="linear" value="key_signature" data-radial="true">KEY</option>
									<option data-scale-type="linear" value="tempo">TEMPO</option>
									<option data-scale-type="linear" value="loudness">LOUDNESS</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="danceability">DANCEABILITY</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="acousticness">ACOUSTICNESS</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="instrumentalness">INSTRUMENTALNESS</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="liveness">LIVENESS</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="speechiness">SPEECHINESS</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="energy">ENERGY</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="valence">VALENCE</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="100" value="popularity">POPULARITY</option>
									<option data-scale-type="linear" value="release_year">YEAR</option>
									<option data-scale-type="linear" value="duration">DURATION</option>
									<!-- <option data-scale-type="linear" value="pca1">PCA1</option>	 -->
								</select>
							</div>
						</div>
						<div class="cell grow">
							<div class="margin-gutter">
								<div>
									<small class="nowrap">Y / Radial Axis</small>
								</div>
								<select name="" class="btn active vis-control" id="select-y-axis" style="width: 100%;">
									<option data-scale-type="linear" value="tempo">TEMPO</option>
									<option data-scale-type="linear" value="loudness">LOUDNESS</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="danceability">DANCEABILITY</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="acousticness">ACOUSTICNESS</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="instrumentalness">INSTRUMENTALNESS</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="liveness">LIVENESS</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="speechiness">SPEECHINESS</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="energy">ENERGY</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="valence">VALENCE</option>
									<option data-scale-type="linear" data-scale-min="0" data-scale-max="100" value="popularity">POPULARITY</option>
									<option data-scale-type="linear" value="release_year">YEAR</option>
									<option data-scale-type="linear" value="duration">DURATION</option>
									<!-- <option data-scale-type="linear" value="pca2">PCA2</option>	 -->
								</select>
							</div>
						</div>
					</div>
					<div class="container-row">
						<div class="cell hide" id="pca-axes-notes">
							<small><i>Turn off "Just cluster similar songs" to enable axes selection</i></small>
						</div>
					</div>

					<div class="grow container-col" style="padding-bottom: 10px;">
							<!-- <div class="grow container-col" style="padding-bottom: 30px;"> -->
						<svg id="radial-view" class="grow" overflow="visible"></svg>
					</div>
					<!-- <div class="" style="padding-top: 20px; padding-bottom: 20px;">
						Other songs similar to your selection:
					</div> -->
				</div>
				<div class="text-center drawer-tab transparent" style="font-size: 10pt;">
					[placeholder]
				</div>
            </div>
			<div style="width: 25%;" class="cell container-col">
				<h2>Song features</h2>
				<svg id="histogram-view" class="grow" overflow="visible"></svg>
				<!-- <h2>Legend</h2>
				<div class="panel">
					<ul>
						<li>Size</li>
						<li>Shape</li>
						<li>Image</li>
					</ul>
				</div> -->
				<p class="text-muted" style="margin-bottom: 0;">
					<small>
						<b>Made by</b>
						<i><a href="https://taepras.com">Tae Prasongpongchai</a>, <a href="https://www.xichen.design/">Xi Chen</a>, <a href="http://www.benjamindupreez.com/">Benjamin Du Preez</a>, <a href="http://fmckenziemurphy.com/">McKenzie Murphy</a></i>
					</small>
				</p>
            </div>
		</div>

		<div id="veil" class="veil hide vis-control"></div>

		<div id="star-view-drawer" class="container-col hide">
			<div id="drop-area" class="cell drawer-tab vis-control clickable">
				<!-- <h2>Detailed Analysis</h2> -->
				<div id="starTitleLabel" class="text-center grow">
					Drag a song here for more details
				</div>
				<div id="starClear"></div>
				<!--<div>
					2 Songs in Comparison [TODO: show number of songs in comparison]
				</div>-->
			</div>
		    <div class="grow">
				<!--<h2 class="mt-0">Song-by-song Comparison</h2>-->
				<svg id="star-view" class="grow" overflow="visible"></svg>
			</div>
		</div>


		<div class="help-tooltip hide">
			<h3 class="help-title">Test Help Tooltip</h3>
			<p class="help-body">This is a test help message on the help tooltip. This is a test help message on the help tooltip. This is a test help message on the help tooltip.</p>
		</div>

		<div class="tutorial-tooltip hide" id="tutorial">
			<div class="speech-bubble">
				<p>
					Test Test
				</p>
			</div>
		</div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.12.0/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js"></script>
        <script src="https://nico-amsterdam.github.io/awesomplete-util/js/awesomplete.min.js"></script>
		  <script src="https://nico-amsterdam.github.io/awesomplete-util/js/awesomplete-util.min.js"></script>
		  <script src="https://unpkg.com/d3-simple-slider"></script>
		<script src="js/lib/pca.min.js"></script>
		<script src="js/utils.js"></script>
		<script src="js/audiohelpers.js"></script>
		<script src="js/helptooltip.js"></script>
        <script src="js/rectangulargrid.js"></script>
        <script src="js/radialgrid.js"></script>
        <!-- <script src="js/radialplot.js"></script> -->
        <script src="js/radialplot_with_split.js"></script>
        <script src="js/histograms.js"></script>
        <script src="js/starplots.js"></script>
        <script src="js/tutorial.js"></script>

        <script>
			var ENABLE_TUTORIAL = true;
			var ENABLE_ALL_TUTORIALS = false;

			var components = [];
			var data = [];

			var dispatch = d3.dispatch('filter', 'highlight');

			callTutorial('#search-artist', 'Try adding your favorite artist<br>to the comparison here!')

			var rv;
			components.push(rv = new RadialView(d3.select('svg#radial-view'), [], dispatch));
			components.push(new HistogramView(d3.select('svg#histogram-view'), [], dispatch));
			// components.push(new StarView(d3.select('svg#star-view'), [], dispatch));

            // Load data and call onDataChanged for components once load is complete

			dispatch.on("filter", function (filterFunc) {
				components.forEach(function (c) { c.onFilter(filterFunc); });
			});

			dispatch.on("highlight", function (filterFunc) {
				components.forEach(function (c) { c.onHighlight(filterFunc); });
			});

            window.addEventListener("resize", function() {
				components.forEach(function (c) { c.onScreenSizeChanged(); });
			});

			// UI initialization from vis's config
			let rvConfig = rv.getConfig();
			d3.select('#select-x-axis').property("value", rvConfig.xMapping.key);
			d3.select('#select-y-axis').property("value", rvConfig.yMapping.key);
			d3.select('#toggle-split-view').property("checked", rvConfig.isSplitting);
			d3.select('#toggle-album-art').property("checked", rvConfig.showAlbumArt);
			d3.select('#toggle-force').property("checked", rvConfig.enableForce);
			d3.select('[name=radio-pca]').property("value", rvConfig.isPca);
			d3.select('#toggle-pca').property("checked", rvConfig.isPca);
			// document.getElementById('radio-pca').checked = rvConfig.isPca;
			// document.getElementById('toggle-pca').checked = rvConfig.isPca;
			updateSplitViewToggle();

			function updateSplitViewToggle () {
				let splitViewToggle = d3.select('#toggle-split-view');
				let splitViewParent = d3.select(splitViewToggle.node().parentNode);
				if (data.length > 1) {
					splitViewToggle.attr('disabled', null);
					splitViewParent.classed('disabled', false);
				}
				else {
					splitViewToggle.attr('disabled', 'disabled');
					splitViewParent.classed('disabled', true);
				}
			}

			// UI events
			d3.selectAll('[name=radio-pca], #toggle-pca')
			// d3.selectAll('#toggle-pca')
				.on('change', function () {
					console.log(this.getAttribute('type'));
					let isChecked = this.getAttribute('type') == 'checkbox' ? this.checked : this.value == 'mode-pca';
					// console.log(this.checked)
					if (isChecked) {
						rv.setConfig({
							xMapping: {
								key: 'pca1',
								scaleType: 'linear',
								minOverride: false,
								maxOverride: false,
								isRadial: false
							},
							yMapping: {
								key: 'pca2',
								scaleType: 'linear',
								minOverride: false,
								maxOverride: false,
								isRadial: false
							},
							showAxes: false
						});
						d3.select('#select-x-axis').attr('disabled', 'disabled');
						d3.select('#select-y-axis').attr('disabled', 'disabled');
						d3.select('#pca-axes-notes').classed('hide', false);
					} else {
						let xSelect = d3.select('#select-x-axis').node();
						let ySelect = d3.select('#select-y-axis').node();
						let xSelectedOption = xSelect.options[xSelect.selectedIndex];
						let ySelectedOption = ySelect.options[ySelect.selectedIndex];
						rv.setConfig({
							xMapping: {
								key: xSelectedOption.value,
								scaleType: xSelectedOption.getAttribute('data-scale-type'),
								minOverride: xSelectedOption.getAttribute('data-scale-min') || false,
								maxOverride: xSelectedOption.getAttribute('data-scale-max') || false,
								isRadial: xSelectedOption.getAttribute('data-radial') || false
							},
							yMapping: {
								key: ySelectedOption.value,
								scaleType: ySelectedOption.getAttribute('data-scale-type'),
								minOverride: ySelectedOption.getAttribute('data-scale-min') || false,
								maxOverride: ySelectedOption.getAttribute('data-scale-max') || false,
								isRadial: ySelectedOption.getAttribute('data-radial') || false
							},
							showAxes: true
						});
						d3.select('#select-x-axis').attr('disabled', null);
						d3.select('#select-y-axis').attr('disabled', null);
						d3.select('#pca-axes-notes').classed('hide', true);
					}
				});

			d3.selectAll('#toggle-split-view').on('change', function (e) {
				rv.setConfig({isSplitting: this.checked});
			});

			d3.selectAll('#toggle-album-art').on('change', function (e) {
				rv.setConfig({showAlbumArt: this.checked});
			});

			d3.selectAll('#toggle-force').on('change', function (e) {
				rv.setConfig({enableForce: this.checked});
			});

			d3.selectAll('#select-x-axis')
				.on('change', function () {
					let selectedOption = this.options[this.selectedIndex];
					rv.setConfig({
						xMapping: {
							key: selectedOption.value,
							scaleType: selectedOption.getAttribute('data-scale-type'),
							minOverride: selectedOption.getAttribute('data-scale-min') || false,
							maxOverride: selectedOption.getAttribute('data-scale-max') || false,
							isRadial: selectedOption.getAttribute('data-radial') || false
						}
					});
				});
			d3.selectAll('#select-y-axis')
				.on('change', function () {
					let selectedOption = this.options[this.selectedIndex];
					rv.setConfig({
						yMapping: {
							key: selectedOption.value,
							scaleType: selectedOption.getAttribute('data-scale-type'),
							minOverride: selectedOption.getAttribute('data-scale-min') || false,
							maxOverride: selectedOption.getAttribute('data-scale-max') || false,
							isRadial: selectedOption.getAttribute('data-radial') || false
						}
					});
				});
			d3.selectAll('#search-highlight')
				.on('keyup', function () {
					dispatch.call('highlight', this, k => k.name ? k.name.toLowerCase().indexOf(this.value.toLowerCase()) >= 0 : false);
				})
				.on('click', function () {
					// this.classList.remove('disabled')
					this.classList.add('active')
					this.select();
					dispatch.call('highlight', this, k => k.name ? k.name.toLowerCase().indexOf(this.value.toLowerCase()) >= 0 : false);
				});

			d3.select('#star-view-drawer .drawer-tab')
				.on('click', function (e) {
					let drawer = this.parentNode;
					d3.select(drawer).classed('hide', !d3.select(drawer).classed('hide'));
					d3.select('#veil').classed('hide', d3.select(drawer).classed('hide'))
				}, false);
			d3.select('#starClear')
				.on('click', function() {
					// console.log("removeAll");
	                new StarView(d3.select('svg#star-view'), [], dispatch).onDataChanged();
				})

			d3.select('#veil')
				.on('click', function () {
					d3.select('#star-view-drawer').classed('hide', true);
					d3.select('#veil').classed('hide', true);
				});


			// d3.selectAll('#star-view-drawer .drawer-tab')
			// 	.data([{}])
			// 	.call(d3.drag()
			// 		.on('start', function(d) {
			// 			d.startX = d3.event.x;
			// 			d.startY = d3.event.y;
			// 		})
			// 		.on('drag', function (d) {
			// 			console.log(d.startY, d3.event.y);
			// 			this.parentNode.style.bottom = (d.startY - d3.event.y) + 'px';
			// 		})
			// 		.on('end', function () {
			// 			console.log(this.parentNode.style.bottom);
			// 			let offsetBottom = parseInt(this.parentNode.style.bottom, 10);
			// 			if (offsetBottom > -80) {
			// 				d3.select(this.parentNode)
			// 					.transition()
			// 					.style('bottom', '');
			// 				this.parentNode.classList.remove('hide');
			// 			} else {
			// 				d3.select(this.parentNode)
			// 					.transition()
			// 					.style('bottom', '');
			// 				this.parentNode.classList.add('hide');
			// 			}
			// 		})
			// 	)

			// Searchbar
			AwesompleteUtil.start('#search-artist',
				{  /* util options */
				   url:    "https://oeeppedclg.execute-api.us-east-1.amazonaws.com/musicoctorobot/search?searchString=",
				   urlEnd: "*",
				   limit: 1
				},
				{  /* awesomplete options */
				   minChars: 1,
				   data: (rec, input) => ({
			         label: rec['name'],
			         value: {"id": rec['id'], "name": rec['name']}
			       })
				}
			);

			let urlParams = new URLSearchParams(window.location.search);
			function applyPromise(array, fn) {
				return Promise.all(array.map(fn))
			}

			window.onpopstate = function () {
				let urlParams = new URLSearchParams(window.location.search);
				let artistsInUrl = urlParams.getAll('q');
				let artistsInDataset = data.map(d => d.id);
				let artistsEnter = artistsInUrl.filter(n => !artistsInDataset.includes(n));
				let artistsExit = artistsInDataset.filter(n => !artistsInUrl.includes(n));

				applyPromise(artistsEnter, loadArtistData)
					.then(function (e) {
						return new Promise.all(e.map(appendArtistData))
					});
				artistsExit.forEach(removeArtistDataById);
			}

			// Promise.all(urlParams.getAll('q').map(d => loadArtistData(d))).then(() => {console.log('!!!')});
			applyPromise(urlParams.getAll('q'), loadArtistData)
				.then(function (e) {
					return Promise.all(e.map(appendArtistData))
				});

			// Listen to searchbar selection
			document.getElementById('search-artist').addEventListener("awesomplete-selectcomplete", function(event) {

			    // Clear the searchbar to be ready for a new search
			    document.getElementById('search-artist').value = "";

			    // Retrieve songs for this artist from our API
				var artistID = event.text.value.id;
				var artistName = event.text.value.name;
				//console.log(artistID);

				loadArtistData(artistID, artistName)
					.then(appendArtistData)
					.then(function () {
						document.title = 'MusicOctoRobot - ' + data.map(d => d.name).join(' v ');
						history.pushState({}, 'MusicOctoRobot - ' + data.map(d => d.name).join(' v '), '?' + data.map(d => 'q=' + d.id).join('&'));
					});
			});

			// helpers
			function preprocessData (data) {
				// TODO: try to remove duplicate data
				data.forEach(function (d) {
					if (d.duration_ms)
						d.duration = d.duration_ms / 1000;
					if (d.release_date)
						d.release_year = d.release_date.indexOf('-') < 0 ?
							+d.release_date :
							+d.release_date.substring(0, d.release_date.indexOf('-'));
				})
			}

			// NOTE arrayJoin was moved to utils.js

			// Loads an array of song data for the given artistID and append that to our dataset
			function loadArtistData(artistID, artistName) {

				// FIXME limit number of collections
				//console.log('loading artist', artistID)

				if (artistID.indexOf('spotify:artist:') >= 0)
					artistID = artistID.substring('spotify:artist:'.length)

				var url = "https://oeeppedclg.execute-api.us-east-1.amazonaws.com/musicoctorobot?artistId=" + artistID + "&name=" + artistName;

				return new Promise(function (resolve, reject) {
					return d3.json(url).then(resolve)//.then()//.catch((error) => console.error(error));
				});
			}

			function appendArtistData (loadedData) {
				return new Promise(function (resolve, reject) {
					preprocessData(loadedData.songs);
					console.log('preprocessed', loadedData);
					// console.log(loadedData);

					// Append to data array
					data.push(loadedData);

					// redraw artist buttons
					drawArtistButtons();

					// trigger a data change for the histograms
					components.forEach(function (c) { c.onDataChanged(data); });
					resolve();

					updateSplitViewToggle();

					if (ENABLE_TUTORIAL && data.length <= 1) {
						callTutorial('#search-artist', 'Try adding your favorite artist<br>to the comparison here!')
					} else if (ENABLE_TUTORIAL && data.length == 2) {
						// callTutorial('#options-panel', 'Now try adjusting the visualization here!')
						callTutorial('#select-x-axis', 'Now try changing the axes here to see other attributes.')
					}
					else if(ENABLE_TUTORIAL && data.length == 3) {
						callTutorial('#options-panel', 'You can also try adjusting<br>more options here.', 'n')
					}

					if (data.length >= 4) {
						d3.select("#search-artist")
							.attr('disabled', 'disabled');
					}
				})
			}

			// Removes the data for the artist at index i from the dataset
			function removeArtistData(i) {

				d3.select("#search-artist").attr("disabled", null);

				// remove data from array
				data.splice(i, 1);

				// redraw artist buttons
				drawArtistButtons();

				// enable/disable split view toggle based on if there're more than one artist loaded
				updateSplitViewToggle();

				// trigger a data change for the histograms
				components.forEach(function (c) { c.onDataChanged(data); });
				document.title = 'MusicOctoRobot - ' + data.map(d => d.name).join(' v ');
				history.pushState({}, 'MusicOctoRobot - ' + data.map(d => d.name).join(' v '), '?' + data.map(d => 'q=' + d.id).join('&'));
			}

			// Removes the data for the artist from the dataset by artist id
			function removeArtistDataById(id) {

				d3.select("#search-artist").attr("disabled", false);

				let removeIndex = data.map(d => d.id).indexOf(id);
				if (removeIndex>= 0)
					removeArtistData(removeIndex);
			}

			function drawArtistButtons() {
				// TODO @Ben, can we draw the artist button
				// immediately after the artist is selected and have like a spinner to show loading instead?
				// the current behavior that the feedback for artist loading is not immediate can make it a little confusing

				let colors = ['#F36293', '#81D0EF','#FCA981', '#6988F2'].slice(0, data.length); // color scheme

				let drawData = data.slice(0);
				drawData.reverse();
				colors.reverse();

				let selection = d3.select("#artist-buttons").selectAll(".artist-btn").data(drawData, (d) => d.id);

				// enter
				let selectionEnter = selection.enter()
						.append("div");

				selectionEnter.attr("class", "artist-btn")
						.attr("data-id", d => d.id)
						.style("border-left", (d, i) => "12px solid " + colors[i])
						.text((d) => d["name"])
						.on('mouseover', function (d, i) {
							dispatch.call('highlight', this, k => k.collection_id == d.id);
						})
						.on('mouseout', function (d, i) {
							dispatch.call('highlight', this, k => true);
						});
				selectionEnter.append("button").html("&times;").on("click", (d,i) => removeArtistData(i));

				// update
				selection.style("border-left", (d, i) => "12px solid " + colors[i]).text((d) => d["name"])
						.append("button").html("&times;").on("click", (d,i) => removeArtistData(i));

				selection.merge(selectionEnter);

				// exit
				selection.exit().remove();
			}



        </script>
    </body>
</html>
