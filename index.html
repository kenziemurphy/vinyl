<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>Music Vis</title>
        <link rel="stylesheet" href="css/radialplot.css" />
    </head>
    <body>
        <div style="display:flex;flex-direction: row;">
            <div style="flex-grow: 1;">
                Search boxes go here
            </div>
            <div style="flex-grow: 2;">
                <div id="radial-view-controls" class="controls fixed">
                    <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="tempo">Tempo</button>
                    <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="danceability">Danceability</button>
                    <button class="btn radial-mapping-select" data-scale-type="log" data-attr="loudness">Loudness</button>
                    <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="acousticness">Acousticness</button>
                    <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="instrumentalness">Instrumentalness</button>
                    <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="liveness">Liveness</button>
                    <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="speechiness">Speechiness</button>
                    <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="energy">Energy</button>
                    <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="valence">Valence</button>
                    <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="duration_ms">Duration (ms)</button>
                    <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="popularity">Popularity</button>
                    <!-- <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="track_number">Track Number</button> -->
                    <!-- <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="key">Key</button> -->
                    <!-- <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="mode">Mode</button> -->
                    <!-- <button class="btn radial-mapping-select" data-scale-type="linear" data-attr="time_signature">Time Signature</button> -->
                </div>
                <div class="vis">
                    <svg id="radial-plot"></svg>
                </div>
            </div>
            <div style="flex-grow: 1;">
                Histograms go here
            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.12.0/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js"></script>
        <script src="js/audiohelpers.js"></script>
        <script src="js/radialplot.js"></script>

        <script>
			var components = [];
			var data = [];

			components.push(new RadialView(d3.select('.vis svg#radial-plot'), []));
			
            Promise.all([
                // d3.json('../../data/Spotify.json'),
                // d3.json('../../data/Spotify_trackinfo.json'),
                // d3.json('data/slotmachine.json'),
                // d3.json('data/slotmachine_trackinfo.json'),
                d3.json("data/radiohead.json"),
                d3.json("data/radiohead_trackinfo.json")
            ]).then(function(loadedData) {
				data = preprocessData(loadedData);
				console.log(data);
				
				components.forEach(function (c) { c.onDataChanged(data); });
            });

            window.addEventListener("resize", function() {
                // initialize();

                // if (fileReady) {
				// d3.selectAll("svg > *").remove();
				components.forEach(function (c) { c.onScreenSizeChanged(); });
                // }
			});
			
			function preprocessData (files) {
				// inner join
				var data = arrayJoin(files[0], files[1].tracks, 'uri');
				return data; 
			}

			function arrayJoin (a, b, key) {
				var bKeys = b.map(y => y[key]);
				var abJoined = a.map(function (x) {
					var bIndex = bKeys.indexOf(x[key])
					if (bIndex >= 0) {
						// console.log(x[key], b[bIndex].name);
						return {...x, ...b[bIndex]};
					} else {
						return false;
					}
				});
				
				return abJoined.filter(x => x !== false);
			}
        </script>
    </body>
</html>
