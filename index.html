<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>MusicOctoRobot</title>
		<link rel="stylesheet" href="https://use.typekit.net/zry1rcu.css">
		<link rel="stylesheet" href="https://nico-amsterdam.github.io/awesomplete-util/css/awesomplete.css">
        <link rel="stylesheet" href="css/grids.css" />
        <link rel="stylesheet" href="css/histograms.css" />
        <link rel="stylesheet" href="css/radialplot.css" />
        <link rel="stylesheet" href="css/starplot.css" />
		<link rel="stylesheet" href="css/main.css" />
		
		<script src="https://kit.fontawesome.com/45bc1cc8f8.js" crossorigin="anonymous"></script>
    </head>
    <body>
		<!-- TODO remove inline CSS -->
        <div class="container-main container-row">
			<div style="width: 25%;" class="cell container-col">
				<h1>MusicOctoRobot</h1>
				<input class="form-control" id="search-artist" name="search[artist]" type="text" placeholder="Search artists..." />

				<br>

				<div id="artist-buttons">
					<!--<div class="artist-btn">Muse<button>&times;</button></div>
					<div class="artist-btn">Radiohead<button>&times;</button></div>
					<div class="artist-btn">Slot Machine<button>&times;</button></div>-->
				</div>


				<br>
				<!-- <svg id="..."></svg> -->
				<div>
					<h2>More Options</h2>
					<div class="container-row">
						<div class="grow margin-gutter" style="width: 33.33%">
							<button id="toggle-split-view" class="btn vis-control">Toggle&shy; split view</button>
						</div>
						<div class="grow margin-gutter" style="width: 33.33%">
							<button id="toggle-album-art" class="btn vis-control">Toggle&shy;  album art</button>
						</div>
						<div class="grow margin-gutter" style="width: 33.33%">
							<button id="toggle-force" class="btn vis-control">Toggle&shy;  force jittering</button>
						</div>
					</div>
					<h2>How to read this visualization</h2>
					<div>
						<p>
							[visuals]
							<ul>
								<li>Position</li>
								<li>Size</li>
								<li>Shape</li>
								<li>Color</li>
								<li>Image</li>
								<li>Image</li>
							</ul>
						</p>
					</div>
				</div>
            </div>
			<div class="cell grow container-col">
				<div id="vis-area" class="cell grow container-col">
					<div class="container-row" style="margin:auto;">
						<div class="text-center margin-gutter">
							<small>X / Angle Axis</small>
							<br>
							<select name="" class="btn active vis-control" id="select-x-axis" style="width: auto;">
								<option data-scale-type="linear" value="key_signature" data-radial="true">KEY</option>
								<option data-scale-type="linear" value="tempo">TEMPO</option>
								<option data-scale-type="linear" value="loudness">LOUDNESS</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="danceability">DANCEABILITY</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="acousticness">ACOUSTICNESS</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="instrumentalness">INSTRUMENTALNESS</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="liveness">LIVENESS</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="speechiness">SPEECHINESS</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="energy">ENERGY</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="valence">VALENCE</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="100" value="popularity">POPULARITY</option>
								<option data-scale-type="linear" value="release_year">YEAR</option>
								<option data-scale-type="linear" value="duration">DURATION</option>
							</select>
						</div>
						<div class="text-center margin-gutter">
							<small>Y / Radial Axis</small>
							<br>
							<select name="" class="btn active vis-control" id="select-y-axis" style="width: auto;">
								<option data-scale-type="linear" value="tempo">TEMPO</option>
								<option data-scale-type="linear" value="loudness">LOUDNESS</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="danceability">DANCEABILITY</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="acousticness">ACOUSTICNESS</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="instrumentalness">INSTRUMENTALNESS</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="liveness">LIVENESS</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="speechiness">SPEECHINESS</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="energy">ENERGY</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="1" value="valence">VALENCE</option>
								<option data-scale-type="linear" data-scale-min="0" data-scale-max="100" value="popularity">POPULARITY</option>
								<option data-scale-type="linear" value="release_year">YEAR</option>
								<option data-scale-type="linear" value="duration">DURATION</option>	
							</select>
						</div>
						<div class="text-center margin-gutter">
							<small>Find a song in this graphic</small>
							<br>
							<input type="text" class="btn vis-control" id="search-highlight">
						</div>
					</div>
					<svg id="radial-view" class="grow" overflow="visible"></svg>
					<div class="" style="padding-top: 20px; padding-bottom: 20px;">
						Other songs similar to your selection:
					</div>
				</div>
				<!--<div class="text-center cell drawer-tab">
					Drag a song here for more details
				</div>-->
            </div>
			<div style="width: 25%;" class="cell container-col">
				<h2>Distribution of songs by song features</h2>
				<svg id="histogram-view" class="grow" overflow="visible"></svg>
            </div>
		</div>
		<div id="star-view-drawer" class="container-col hide">
			<div id="drop-area" class="text-center cell drawer-tab">
				<!-- <h2>Detailed Analysis</h2> -->
				<div>
					Drag a song here for more details / X Songs in Comparison
				</div>
				<!-- <div>
					2 Songs in Comparison [TODO: show number of songs in comparison]
				</div> -->
			</div>
		    <div style="grow">
				<h2 class="mt-0">Song-by-song Comparison</h2>
				<svg id="star-view" class="grow" overflow="visible"></svg>
			</div>
		</div>

		<div class="help-tooltip hide">
			<h3 class="help-title">Test Help Tooltip</h3>
			<p class="help-body">This is a test help message on the help tooltip. This is a test help message on the help tooltip. This is a test help message on the help tooltip.</p>
		</div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.12.0/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js"></script>
        <script src="https://nico-amsterdam.github.io/awesomplete-util/js/awesomplete.min.js"></script>
  		<script src="https://nico-amsterdam.github.io/awesomplete-util/js/awesomplete-util.min.js"></script>
		<script src="js/utils.js"></script>
		<script src="js/audiohelpers.js"></script>
		<script src="js/helptooltip.js"></script>
        <script src="js/rectangulargrid.js"></script>
        <script src="js/radialgrid.js"></script>
        <!-- <script src="js/radialplot.js"></script> -->
        <script src="js/radialplot_with_split.js"></script>
        <script src="js/histograms.js"></script>
        <script src="js/starplots.js"></script>

        <script>
			var components = [];
			var data = [];

			var dispatch = d3.dispatch('filter', 'highlight');

			var rv
			components.push(rv = new RadialView(d3.select('svg#radial-view'), [], dispatch));
			components.push(new HistogramView(d3.select('svg#histogram-view'), [], dispatch));
			//components.push(new StarView(d3.select('svg#star-view'), [], dispatch));

            // Load data and call onDataChanged for components once load is complete

			dispatch.on("filter", function (filterFunc) {
				components.forEach(function (c) { c.onFilter(filterFunc); });
			});

			dispatch.on("highlight", function (filterFunc) {
				components.forEach(function (c) { c.onHighlight(filterFunc); });
			});

            window.addEventListener("resize", function() {
				components.forEach(function (c) { c.onScreenSizeChanged(); });
			});

			// UI events
			document.getElementById('toggle-split-view')
				.addEventListener('click', function (e) {
					rv.setConfig({isSplitting: !rv.config.isSplitting});
				}, false);

			document.getElementById('toggle-album-art')
				.addEventListener('click', function (e) {
					rv.setConfig({showAlbumArt: !rv.config.showAlbumArt});
				}, false);

			document.getElementById('toggle-force')
				.addEventListener('click', function (e) {
					rv.setConfig({enableForce: !rv.config.enableForce});
				}, false);

			document.querySelector('#star-view-drawer .drawer-tab')
				.addEventListener('click', function (e) {
					if (this.parentNode.classList.contains('hide'))
						this.parentNode.classList.remove('hide')
					else
						this.parentNode.classList.add('hide')
				}, false);

			// Searchbar
			AwesompleteUtil.start('#search-artist',
				{  /* util options */
				   url:    "https://oeeppedclg.execute-api.us-east-1.amazonaws.com/musicoctorobot/search?searchString=",
				   urlEnd: "*",
				   limit: 1
				}, 
				{  /* awesomplete options */
				   minChars: 1,
				   data: (rec, input) => ({ 
			         label: rec['name'], 
			         value: rec['id']
			       })
				}
			);

			let urlParams = new URLSearchParams(window.location.search);
			function loadArtistsFromUrl(array, fn) {
				// FIXME keep ordering consistent
				return Promise.all(array.map(d => appendArtistData(d)))
				// var index = 0;
				// function next() {
				// 	if (index < array.length) {
				// 		fn(array[index++]).then(next);
				// 	}
				// }
				// return new Promise(function (resolve, reject) {
				// 	// FIXME promise doesn't work
				// 	next();
				// })
			}

			window.onpopstate = function () {
				let urlParams = new URLSearchParams(window.location.search);
				let artistsInUrl = urlParams.getAll('q');
				let artistsInDataset = data.map(d => d.id);
				let artistsEnter = artistsInUrl.filter(n => !artistsInDataset.includes(n));
				let artistsExit = artistsInDataset.filter(n => !artistsInUrl.includes(n));

				loadArtistsFromUrl(artistsEnter, appendArtistData);
				artistsExit.forEach(removeArtistDataById);
			}

			loadArtistsFromUrl(urlParams.getAll('q'), appendArtistData).then(function () { console.log('done') });

			// Listen to searchbar selection
			document.getElementById('search-artist').addEventListener("awesomplete-selectcomplete", function(event) {

			    // Clear the searchbar to be ready for a new search
			    document.getElementById('search-artist').value = "";

			    // Retrieve songs for this artist from our API
				var artistID = event.text.value;
				console.log(artistID);
				
				appendArtistData(artistID).then(function () {
					document.title = 'MusicOctoRobot - ' + data.map(d => d.name).join(' v ');
					history.pushState({}, 'MusicOctoRobot - ' + data.map(d => d.name).join(' v '), '?' + data.map(d => 'q=' + d.id).join('&'));
				});
			});

			// helpers
			function preprocessData (data) {
				data.forEach(function (d) {
					if (d.duration_ms)
						d.duration = d.duration_ms / 1000;
					if (d.album && d.album.release_date)
						d.release_year = d.album.release_date.indexOf('-') < 0 ?
							+d.album.release_date :
							+d.album.release_date.substring(0, d.album.release_date.indexOf('-'));
				})
			}

			// NOTE arrayJoin was moved to utils.js

			// Loads an array of song data for the given artistID and append that to our dataset
			function appendArtistData(artistID) {
				// FIXME limit number of collections

				if (artistID.indexOf('spotify:artist:') >= 0)
					artistID = artistID.substring('spotify:artist:'.length)
				
				var url = "https://oeeppedclg.execute-api.us-east-1.amazonaws.com/musicoctorobot?artistId=" + artistID;

				return new Promise(function (resolve, reject) {
					d3.json(url).then((loadedData) => {

						preprocessData(loadedData.songs);
						// console.log(loadedData);

						// Append to data array
						data.push(loadedData);

						// redraw artist buttons
						drawArtistButtons();

						// trigger a data change for the histograms
						components.forEach(function (c) { c.onDataChanged(data); });
						resolve();

					})//.catch((error) => console.error(error));
				});
			}

			// Removes the data for the artist at index i from the dataset
			function removeArtistData(i) {

				// remove data from array
				data.splice(i, 1);

				// redraw artist buttons
				drawArtistButtons();

				// trigger a data change for the histograms
				components.forEach(function (c) { c.onDataChanged(data); });
				document.title = 'MusicOctoRobot - ' + data.map(d => d.name).join(' v ');
				history.pushState({}, 'MusicOctoRobot - ' + data.map(d => d.name).join(' v '), '?' + data.map(d => 'q=' + d.id).join('&'));
			}

			// Removes the data for the artist from the dataset by artist id
			function removeArtistDataById(id) {
				let removeIndex = data.map(d => d.id).indexOf(id);
				if (removeIndex>= 0)
					removeArtistData(removeIndex);
			}

			function drawArtistButtons() {
				// TODO @Ben, can we draw the artist button 
				// immediately after the artist is selected and have like a spinner to show loading instead?
				// the current behavior that the feedback for artist loading is not immediate can make it a little confusing

				let colors = ['#fca981', '#6988f2', '#f36293', '#81d0ef']; // color scheme

				console.log(data);

				let selection = d3.select("#artist-buttons").selectAll(".artist-btn").data(data);

				// enter
				let selectionEnter = selection.enter()
						.append("div");

				selectionEnter.attr("class", "artist-btn")
						.attr("data-id", d => d.id)
						.style("border-left", (d, i) => "12px solid " + colors[i])
						.text((d) => d["name"])
						.on('mouseover', function (d, i) {
							dispatch.call('highlight', this, k => k.collection_id == d.id);
						})
						.on('mouseout', function (d, i) {
							dispatch.call('highlight', this, k => true);
						});;
				selectionEnter.append("button").html("&times;").on("click", (d,i) => removeArtistData(i));
						

				// update
				selection.style("border-left", (d, i) => "12px solid " + colors[i]).text((d) => d["name"])
						.append("button").html("&times;").on("click", (d,i) => removeArtistData(i));;

				selection.merge(selectionEnter);

				// exit
				selection.exit().remove();
			}



        </script>
    </body>
</html>
